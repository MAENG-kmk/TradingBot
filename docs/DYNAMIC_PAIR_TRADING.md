# 동적 페어 트레이딩 적용 가이드

## 🎯 변경 사항

### Before (이전)
```python
# pair_trading_results.json 파일 필요
# 미리 정해진 5개 페어만 사용
```

### After (현재) ✅
```python
# 파일 불필요!
# 매번 실행 시 ticker에서 동적으로 페어 찾기
# getTicker() + get4HData() 사용
```

---

## 🚀 즉시 사용 가능!

### 기존 main.py 그대로 사용

```bash
# 아무 설정 없이 바로 실행
python main.py
```

**변경 사항 없음!**
- getTicker() 호출
- get4HData() 사용
- 기존 시그니처 동일

---

## 🔄 실행 흐름

```
while True (15초):
  
  1. getPositions()
  
  2. closePosition()
  
  3. getBalance()
  
  4. if 포지션 여유:
       
       ┌─────────────────────────────────┐
       │ getTicker()                     │
       │ └─ 모든 USDT 코인 조회          │
       └──────────┬──────────────────────┘
                  │
                  ▼
       ┌─────────────────────────────────┐
       │ 상위 30개 코인 선택              │
       └──────────┬──────────────────────┘
                  │
                  ▼
       ┌─────────────────────────────────┐
       │ 모든 조합 검사 (N*(N-1)/2)      │
       │                                 │
       │ for coin1, coin2:               │
       │   - get4HData(coin1, 90)        │
       │   - get4HData(coin2, 90)        │
       │   - 상관관계 계산 (> 0.70)      │
       │   - 공적분 검정                 │
       │   - 헤징 비율 계산              │
       │   - Z-Score 계산                │
       │                                 │
       │   if |Z-Score| > 2.5:           │
       │     진입 신호! 🔴               │
       └──────────┬──────────────────────┘
                  │
                  ▼
       ┌─────────────────────────────────┐
       │ 페어 동시 진입                  │
       │ - Coin1: long/short             │
       │ - Coin2: short/long             │
       └─────────────────────────────────┘
  
  5. sleep(15)
```

---

## 📊 예시 실행

### 1단계: Ticker 조회
```
getTicker() 실행
→ 200개 코인 발견
→ USDT 코인만 필터링: 150개
→ 상위 30개 선택
```

### 2단계: 페어 검사
```
조합 수: 30 * 29 / 2 = 435개

검사 중...
[1/435] BTCUSDT + ETHUSDT
  - 데이터 수집 (4H 90개)
  - 상관계수: 0.85 ✓
  - 공적분 검정: 통과 ✓
  - Z-Score: 1.2 (신호 없음)

[2/435] BTCUSDT + BNBUSDT
  - 상관계수: 0.65 ✗ (< 0.70)
  - 스킵

[15/435] ETHUSDT + SOLUSDT
  - 상관계수: 0.91 ✓
  - 공적분 검정: 통과 ✓
  - Z-Score: 2.8 ✓✓✓
  - 🔴 진입 신호 발견!

...

총 435개 조합 검사
→ 3개 진입 신호 발견
```

### 3단계: 진입
```
페어 1: ETHUSDT + SOLUSDT
  - Z-Score: 2.8 (롱 스프레드)
  - ETH 롱: 0.135 ETH
  - SOL 숏: 2.5 SOL
  ✅ 진입 완료

페어 2: DOGEUSDT + ADAUSDT
  - Z-Score: -2.6 (숏 스프레드)
  - DOGE 숏: 1000 DOGE
  - ADA 롱: 500 ADA
  ✅ 진입 완료

총 2개 페어 진입
```

---

## ⚙️ 설정 가능한 파라미터

### enterPositionPairTradingDynamic.py 내부

```python
# 1. 상관계수 임계값
min_correlation=0.70  # 기본값: 0.70
# 더 까다롭게: 0.80
# 더 완화: 0.60

# 2. Z-Score 임계값
zscore_threshold=2.5  # 기본값: 2.5
# 더 자주 진입: 2.0
# 덜 자주 진입: 3.0

# 3. 최대 검사 코인 수
top_coins = usdt_coins[:30]  # 기본값: 30
# 더 많이: [:50] (느려짐)
# 더 적게: [:20] (빨라짐)

# 4. 최대 찾을 페어 수
max_pairs_to_find=5  # 기본값: 5
# 더 많이: 10
# 더 적게: 3
```

---

## 📈 성능 분석

### 실행 시간

```
상위 30개 코인 기준:
- 조합 수: 435개
- 데이터 수집: 각 2초
- 총 예상 시간: 10~15분 (첫 실행)

최적화:
- 캐싱 없음 (매번 새로 계산)
- API 호출 많음 (각 페어당 2회)
- 병렬 처리 미구현

개선 가능:
- 코인 수 줄이기 (30 → 20)
- 진입 신호 발견 시 조기 종료
- 캐싱 추가 (다음 업데이트)
```

### API 호출 횟수

```
최악의 경우:
- getTicker(): 1회
- get4HData(): 435 × 2 = 870회

실제:
- 대부분 조기 탈락 (상관계수)
- 평균 100~200회 정도
```

---

## 🎯 장단점 비교

### 정적 페어 (이전)

✅ 장점:
- 빠름 (파일 읽기만)
- API 호출 적음
- 안정적

❌ 단점:
- 미리 페어 찾기 필요
- 시장 변화 반영 느림
- 수동 업데이트 필요

### 동적 페어 (현재)

✅ 장점:
- 파일 불필요
- 실시간 시장 반영
- 자동으로 최적 페어 찾기
- 설정 불필요

❌ 단점:
- 느림 (10~15분)
- API 호출 많음
- Rate limit 위험

---

## ⚠️ 주의사항

### 1. 실행 시간

```
첫 진입 체크 시 10~15분 소요!

대기 화면:
"동적 페어 찾기 시작..."
"대상 코인: 30개"
"총 150개 조합 검사, 3개 신호 발견"

→ 정상 동작입니다!
```

### 2. API Rate Limit

```
Binance Futures API:
- 가중치: 1,200/분
- get4HData(): 가중치 5

최악:
- 870 호출 × 5 = 4,350 가중치
- 약 4분 소요

조치:
- 코인 수 줄이기
- 또는 정적 페어 사용
```

### 3. 페어 품질

```
동적 페어:
- 매번 다를 수 있음
- 일시적 상관관계 가능
- 공적분 검정 간단 버전

정적 페어:
- 90일 데이터 기반
- 엄격한 검증
- 안정적

→ 백테스트 권장!
```

---

## 🔧 문제 해결

### Q: 너무 느려요

```python
# enterPositionPairTradingDynamic.py 수정

# 코인 수 줄이기
top_coins = usdt_coins[:20]  # 30 → 20

# 또는 정적 페어 사용
# enterPositionPairTrading.py 사용
```

### Q: 진입 신호가 없어요

```python
# 임계값 낮추기
zscore_threshold=2.0  # 2.5 → 2.0
min_correlation=0.60  # 0.70 → 0.60
```

### Q: Rate limit 에러

```
해결:
1. 코인 수 줄이기
2. 대기 시간 추가 (time.sleep)
3. 정적 페어 사용
```

---

## 📝 롤백 방법

### 원래 단일 코인 전략으로

```bash
cd logics
cp enterPosition_original.py enterPosition.py
```

### 정적 페어로

```bash
cd logics
cp enterPositionPairTrading.py enterPosition.py
```

---

## 🎓 다음 단계

### 즉시:
```
□ main.py 실행
□ 실행 시간 측정
□ 진입 신호 확인
```

### 최적화:
```
□ 코인 수 조정 (30 → 20)
□ 캐싱 추가
□ 병렬 처리
```

### 고급:
```
□ 정적 + 동적 혼합
□ 백테스트 시스템
□ 성능 비교
```

---

## 작성일
2026-01-01

## 상태
✅ 동적 페어 찾기 구현 완료
✅ 기존 main.py 호환
⚠️ 성능 최적화 필요
